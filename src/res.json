[
  {
    "success": true,
    "status": "SUCCESS",
    "code": 200,
    "payload": [
      {
        "audience_id": "c3c18e5d-65c6-7ec7-c1d3-b006c3e0c6b1",
        "error": "400 Name birtdate not found inside cp at [85:14]; reason: invalidQuery, location: query, message: Name birtdate not found inside cp at [85:14]\n\nLocation: EU\nJob ID: 17a1bb0e-3f6b-4b2b-9942-c703d33f7779\n",
        "rule_group_errors": {
          "e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46": [
            "Unsupported rule type: last_order_date_v1"
          ]
        },
        "sql": "CREATE OR REPLACE VIEW `win-p-mobileuniverse.boxalino_admin_audience_views.audiences_customers_c3c18e5d_65c6_7ec7_c1d3_b006c3e0c6b1` AS (\n\nWITH\n  \n  -- Parent audience e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46 rule groups\n  \n  parent_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_rg_0 AS (\n    SELECT\n      'e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46' as audience_id,\n      0 as rule_group_id,\n      cp.customer_id,\n      cp.last_2year.total_crncy_amt AS total_crncy_amt\n    FROM `bx-bdp-53322.mobile_universe_api_reports.customer_primary_profile` cp\n    WHERE FALSE\n  ),\n  \n  -- Combine parent rule groups for e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46\n  PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_ALL_MATCHES AS (\n    SELECT * FROM parent_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_rg_0\n  ),\n  \n  -- Group by customer to count matched rule groups for e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46\n  PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_RULE_COUNTS AS (\n    SELECT\n      customer_id,\n      COUNT(DISTINCT rule_group_id) as matched_rule_groups\n    FROM PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_ALL_MATCHES\n    GROUP BY customer_id\n  ),\n  \n  -- Final parent audience customers for e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46\n  PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_CUSTOMERS AS (\n    SELECT DISTINCT customer_id\n    FROM PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_RULE_COUNTS\n    WHERE \n      ('or' = 'or' AND matched_rule_groups > 0)\n      OR \n      ('or' != 'or' AND matched_rule_groups = 1)\n  ),\n\n\n  AUDIENCES AS (\n    SELECT audience_id, logical_operator, rule_groups, \n           COALESCE(name, '') as name, \n           COALESCE(description, '') as description,\n           created_at, updated_at, \n           CAST(COALESCE(is_deleted, false) AS STRING) as is_deleted,\n           parent_audience_id\n    FROM `win-p-mobileuniverse.boxalino_admin.audiences_audiences`\n    WHERE audience_id IN ('c3c18e5d-65c6-7ec7-c1d3-b006c3e0c6b1')\n  ),\n\n  -- Global totals for audiences without parents\n  TOTALS_GLOBAL AS (\n    SELECT\n      CAST(NULL AS STRING) as parent_audience_id,\n      COUNT(*) as total_customers,\n      SUM(cp.last_2year.total_crncy_amt) as total_value\n    FROM `bx-bdp-53322.mobile_universe_api_reports.customer_primary_profile` cp\n  ),\n  -- Totals for parent audience e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46\n  TOTALS_PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46 AS (\n    SELECT\n      'e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46' as parent_audience_id,\n      COUNT(*) as total_customers,\n      SUM(cp.last_2year.total_crncy_amt) as total_value\n    FROM `bx-bdp-53322.mobile_universe_api_reports.customer_primary_profile` cp\n    INNER JOIN PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_CUSTOMERS parent_filter ON cp.customer_id = parent_filter.customer_id\n  ),\n\n  -- Combined totals from all sources\n  ALL_TOTALS AS (\n    SELECT * FROM TOTALS_GLOBAL\n    UNION ALL SELECT * FROM TOTALS_PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46\n  ),\n\n  \n  rg_c3c18e5d_65c6_7ec7_c1d3_b006c3e0c6b1_0 AS (\n    SELECT\n      'c3c18e5d-65c6-7ec7-c1d3-b006c3e0c6b1' as audience_id,\n      0 as rule_group_id,\n      cp.customer_id,\n      cp.last_2year.total_crncy_amt AS total_crncy_amt\n    FROM `bx-bdp-53322.mobile_universe_api_reports.customer_primary_profile` cp INNER JOIN PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_CUSTOMERS parent_filter ON cp.customer_id = parent_filter.customer_id\n    WHERE cp.birtdate < '2025-09-29'\n  ),\n\n  ALL_MATCHES AS (\n    SELECT * FROM rg_c3c18e5d_65c6_7ec7_c1d3_b006c3e0c6b1_0\n  ),\n\n  -- Rule group statistics\n  RULE_GROUP_STATS AS (\n    SELECT\n      audience_id,\n      rule_group_id,\n      COUNT(DISTINCT customer_id) as customers,\n      COALESCE(SUM(total_crncy_amt), 0) as customer_value\n    FROM ALL_MATCHES\n    GROUP BY audience_id, rule_group_id\n  ),\n\n  -- Customer rule group counts per audience\n  CUSTOMER_RULE_COUNTS AS (\n    SELECT\n      audience_id,\n      customer_id,\n      total_crncy_amt,\n      COUNT(DISTINCT rule_group_id) as matched_rule_groups\n    FROM ALL_MATCHES\n    GROUP BY audience_id, customer_id, total_crncy_amt\n  ),\n\n  -- Final audience customers based on logical operator\n  FINAL_AUDIENCE_CUSTOMERS AS (\n    SELECT\n      crc.audience_id,\n      crc.customer_id,\n      crc.total_crncy_amt\n    FROM CUSTOMER_RULE_COUNTS crc\n    JOIN AUDIENCES a ON crc.audience_id = a.audience_id\n  WHERE \n    (LOWER(a.logical_operator) = 'or' AND crc.matched_rule_groups > 0)\n    OR \n    (LOWER(a.logical_operator) != 'or' AND crc.matched_rule_groups = ARRAY_LENGTH(a.rule_groups))\n  )\n\n\n\nSELECT\n  audience_id,\n  fac.customer_id,\n  cp.email,\n  cp.lifetime_total_crncy_amt,\n  cp.region_cd\nFROM FINAL_AUDIENCE_CUSTOMERS fac\nLEFT JOIN `bx-bdp-53322.mobile_universe_api_reports.customer_primary_profile` cp ON cp.customer_id = fac.customer_id\n\nORDER BY audience_id\n\n)",
        "success": false,
        "view_name": "audiences_customers_c3c18e5d_65c6_7ec7_c1d3_b006c3e0c6b1"
      }
    ],
    "tm": "20250910104641",
    "errors": []
  },
  {
    "success": true,
    "status": "SUCCESS",
    "code": 200,
    "payload": [
      {
        "audience_id": "c3c18e5d-65c6-7ec7-c1d3-b006c3e0c6b1",
        "error": "400 Name birtdate not found inside cp at [85:14]; reason: invalidQuery, location: query, message: Name birtdate not found inside cp at [85:14]\n\nLocation: EU\nJob ID: b265ebc6-8e71-4c14-8548-6174e72e0650\n",
        "sql": "CREATE OR REPLACE VIEW `win-p-mobileuniverse.boxalino_admin_audience_views.audiences_customers_c3c18e5d_65c6_7ec7_c1d3_b006c3e0c6b1` AS (\n\nWITH\n  \n  -- Parent audience e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46 rule groups\n  \n  parent_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_rg_0 AS (\n    SELECT\n      'e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46' as audience_id,\n      0 as rule_group_id,\n      cp.customer_id,\n      cp.last_2year.total_crncy_amt AS total_crncy_amt\n    FROM `bx-bdp-53322.mobile_universe_api_reports.customer_primary_profile` cp\n    WHERE cp.age > 45\n  ),\n  \n  -- Combine parent rule groups for e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46\n  PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_ALL_MATCHES AS (\n    SELECT * FROM parent_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_rg_0\n  ),\n  \n  -- Group by customer to count matched rule groups for e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46\n  PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_RULE_COUNTS AS (\n    SELECT\n      customer_id,\n      COUNT(DISTINCT rule_group_id) as matched_rule_groups\n    FROM PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_ALL_MATCHES\n    GROUP BY customer_id\n  ),\n  \n  -- Final parent audience customers for e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46\n  PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_CUSTOMERS AS (\n    SELECT DISTINCT customer_id\n    FROM PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_RULE_COUNTS\n    WHERE \n      ('or' = 'or' AND matched_rule_groups > 0)\n      OR \n      ('or' != 'or' AND matched_rule_groups = 1)\n  ),\n\n\n  AUDIENCES AS (\n    SELECT audience_id, logical_operator, rule_groups, \n           COALESCE(name, '') as name, \n           COALESCE(description, '') as description,\n           created_at, updated_at, \n           CAST(COALESCE(is_deleted, false) AS STRING) as is_deleted,\n           parent_audience_id\n    FROM `win-p-mobileuniverse.boxalino_admin.audiences_audiences`\n    WHERE audience_id IN ('c3c18e5d-65c6-7ec7-c1d3-b006c3e0c6b1')\n  ),\n\n  -- Global totals for audiences without parents\n  TOTALS_GLOBAL AS (\n    SELECT\n      CAST(NULL AS STRING) as parent_audience_id,\n      COUNT(*) as total_customers,\n      SUM(cp.last_2year.total_crncy_amt) as total_value\n    FROM `bx-bdp-53322.mobile_universe_api_reports.customer_primary_profile` cp\n  ),\n  -- Totals for parent audience e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46\n  TOTALS_PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46 AS (\n    SELECT\n      'e97f341a-89c9-1bcb-b9c6-cbdf7ac6eb46' as parent_audience_id,\n      COUNT(*) as total_customers,\n      SUM(cp.last_2year.total_crncy_amt) as total_value\n    FROM `bx-bdp-53322.mobile_universe_api_reports.customer_primary_profile` cp\n    INNER JOIN PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_CUSTOMERS parent_filter ON cp.customer_id = parent_filter.customer_id\n  ),\n\n  -- Combined totals from all sources\n  ALL_TOTALS AS (\n    SELECT * FROM TOTALS_GLOBAL\n    UNION ALL SELECT * FROM TOTALS_PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46\n  ),\n\n  \n  rg_c3c18e5d_65c6_7ec7_c1d3_b006c3e0c6b1_0 AS (\n    SELECT\n      'c3c18e5d-65c6-7ec7-c1d3-b006c3e0c6b1' as audience_id,\n      0 as rule_group_id,\n      cp.customer_id,\n      cp.last_2year.total_crncy_amt AS total_crncy_amt\n    FROM `bx-bdp-53322.mobile_universe_api_reports.customer_primary_profile` cp INNER JOIN PARENT_e97f341a_89c9_1bcb_b9c6_cbdf7ac6eb46_CUSTOMERS parent_filter ON cp.customer_id = parent_filter.customer_id\n    WHERE cp.birtdate < '2025-09-29'\n  ),\n\n  ALL_MATCHES AS (\n    SELECT * FROM rg_c3c18e5d_65c6_7ec7_c1d3_b006c3e0c6b1_0\n  ),\n\n  -- Rule group statistics\n  RULE_GROUP_STATS AS (\n    SELECT\n      audience_id,\n      rule_group_id,\n      COUNT(DISTINCT customer_id) as customers,\n      COALESCE(SUM(total_crncy_amt), 0) as customer_value\n    FROM ALL_MATCHES\n    GROUP BY audience_id, rule_group_id\n  ),\n\n  -- Customer rule group counts per audience\n  CUSTOMER_RULE_COUNTS AS (\n    SELECT\n      audience_id,\n      customer_id,\n      total_crncy_amt,\n      COUNT(DISTINCT rule_group_id) as matched_rule_groups\n    FROM ALL_MATCHES\n    GROUP BY audience_id, customer_id, total_crncy_amt\n  ),\n\n  -- Final audience customers based on logical operator\n  FINAL_AUDIENCE_CUSTOMERS AS (\n    SELECT\n      crc.audience_id,\n      crc.customer_id,\n      crc.total_crncy_amt\n    FROM CUSTOMER_RULE_COUNTS crc\n    JOIN AUDIENCES a ON crc.audience_id = a.audience_id\n  WHERE \n    (LOWER(a.logical_operator) = 'or' AND crc.matched_rule_groups > 0)\n    OR \n    (LOWER(a.logical_operator) != 'or' AND crc.matched_rule_groups = ARRAY_LENGTH(a.rule_groups))\n  )\n\n\n\nSELECT\n  audience_id,\n  fac.customer_id,\n  cp.email,\n  cp.lifetime_total_crncy_amt,\n  cp.region_cd\nFROM FINAL_AUDIENCE_CUSTOMERS fac\nLEFT JOIN `bx-bdp-53322.mobile_universe_api_reports.customer_primary_profile` cp ON cp.customer_id = fac.customer_id\n\nORDER BY audience_id\n\n)",
        "success": false,
        "view_name": "audiences_customers_c3c18e5d_65c6_7ec7_c1d3_b006c3e0c6b1"
      }
    ],
    "tm": "20250911061041",
    "errors": []
  }
]
